#!/usr/bin/env bash
set -euo pipefail

show_help() {
  cat << EOF
signrelease 0.0.0

Easy automated release signing.

Usage: signrelease <tag> <pgpkey>

Examples:
    signrelease v0.1.2 Umbrel
    signrelease v0.1.2 pgp@getumbrel.com

GitHub: https://github.com/lukechilds/signrelease
EOF
}

check_dependencies () {
  for cmd in "$@"; do
    if ! command -v $cmd >/dev/null 2>&1; then
      log "This script requires \"${cmd}\" to be installed"
      exit 1
    fi
  done
}

main () {
  # Check deps before running any commands
  check_dependencies

  # Make sure params are set
  if [[ -z ${1+x} ]] || [[ -z ${2+x} ]]; then
    show_help
    exit 1
  fi

  tag=$1
  pgp_key=$2

  repo=$(basename $(git rev-parse --show-toplevel))
  archive_name="${repo}-${tag}"

  temp_dir="$(mktemp -d)"
  shasums_filename="SHASUMS256.txt.asc"
  shasums_filepath="${temp_dir}/${shasums_filename}"

  echo "Building release archives for ${tag}..."
  echo "Building ${archive_name}.tar.gz..."
  git archive --format=tar.gz -o "${temp_dir}/${archive_name}.tar.gz" "${tag}"
  echo "Building ${archive_name}.zip..."
  git archive --format=zip -o "${temp_dir}/${archive_name}.zip" "${tag}"
  echo "Calculating shasums..."
  shasums="$(cd "${temp_dir}" && shasum --algorithm 256 *)"
  echo "Signing shasums with key \"${pgp_key}\"..."
  export GPG_TTY=$(tty)
  signed_shasums=$(echo "${shasums}" | gpg --clearsign --local-user "${pgp_key}" > $shasums_filepath)
  echo "Done!"
  echo
  echo "Release assets at:"
  echo "${temp_dir}"
  echo
  cat "${shasums_filepath}"
}

main $@
